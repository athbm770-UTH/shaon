<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>×©×¢×•×Ÿ × ×•×›×—×•×ª</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â±</text></svg>">
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{font-family:'Segoe UI',Tahoma,Arial,sans-serif;direction:rtl;background:#0f172a;color:#f8fafc;min-height:100vh;overflow-x:hidden}
@keyframes pulse{0%{transform:scale(1);opacity:.6}50%{transform:scale(1.4);opacity:0}100%{transform:scale(1);opacity:0}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes toastSlide{from{opacity:0;transform:translate(-50%,-100%)}to{opacity:1;transform:translate(-50%,0)}}

.app{max-width:440px;margin:0 auto;min-height:100vh;background:linear-gradient(160deg,#0f172a,#1e293b,#0f172a);position:relative}

.login{min-height:100vh;display:flex;flex-direction:column;justify-content:center;padding:40px 24px;animation:fadeIn .5s}
.logo-area{text-align:center;margin-bottom:48px}
.logo-circle{width:80px;height:80px;border-radius:24px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 20px;box-shadow:0 8px 32px rgba(59,130,246,.3)}
.app-title{font-size:28px;font-weight:700}
.app-subtitle{font-size:15px;color:#94a3b8;margin-top:8px}
.login-form{display:flex;flex-direction:column;gap:12px}
.field-label{font-size:14px;color:#94a3b8;font-weight:500}
input[type=text],input[type=email]{padding:16px 18px;border-radius:14px;border:1.5px solid #334155;background:#1e293b;color:#f8fafc;font-size:16px;font-family:inherit;outline:none;width:100%}
input:focus{border-color:#3b82f6}
.btn{padding:16px;border-radius:14px;border:none;color:#fff;font-size:16px;font-weight:600;font-family:inherit;cursor:pointer;width:100%;transition:opacity .2s}
.btn:disabled{opacity:.4;cursor:default}
.btn-blue{background:linear-gradient(135deg,#3b82f6,#1d4ed8);box-shadow:0 4px 20px rgba(59,130,246,.3)}
.btn-green{background:linear-gradient(135deg,#22c55e,#16a34a);box-shadow:0 4px 24px rgba(34,197,94,.3);font-size:18px}
.btn-red{background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 4px 24px rgba(239,68,68,.3);font-size:18px;margin-top:20px}
.login-note{text-align:center;font-size:13px;color:#475569;margin-top:16px}

.top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.05)}
.top-name{font-size:14px;color:#94a3b8}
.top-badge{font-size:11px;color:#22c55e;background:rgba(34,197,94,.1);padding:3px 8px;border-radius:6px;margin-right:8px}
.small-btn{background:none;border:1px solid #334155;border-radius:8px;color:#64748b;font-size:12px;padding:6px 12px;font-family:inherit;cursor:pointer}

.tab-bar{display:flex;padding:8px 16px 0;gap:6px}
.tab{flex:1;padding:12px;border-radius:12px 12px 0 0;border:none;background:rgba(255,255,255,.03);color:#64748b;font-size:15px;font-weight:500;font-family:inherit;cursor:pointer}
.tab.active{background:rgba(59,130,246,.12);color:#60a5fa;font-weight:600}

.header{text-align:center;padding:20px 24px 16px;background:linear-gradient(180deg,rgba(59,130,246,.08),transparent)}
.date-text{font-size:13px;color:#64748b;margin-bottom:8px}
.clock-display{font-size:48px;font-weight:300;letter-spacing:2px;color:#e2e8f0;font-variant-numeric:tabular-nums;margin-bottom:8px}
.today-summary{font-size:14px;color:#64748b;padding:8px 16px;background:rgba(255,255,255,.03);border-radius:10px;display:inline-block}

.action-card{margin:8px 16px;padding:28px 20px;background:linear-gradient(145deg,#1e293b,#162032);border-radius:20px;border:1px solid rgba(255,255,255,.06);animation:fadeIn .4s;text-align:center}
.action-hint{margin-bottom:16px;font-size:15px;color:#64748b}

.active-session{text-align:center;padding:12px 0}
.pulse-box{position:relative;width:72px;height:72px;margin:0 auto 16px}
.pulse-ring{position:absolute;inset:0;border-radius:50%;background:rgba(34,197,94,.2);animation:pulse 2s infinite}
.pulse-core{position:absolute;inset:8px;border-radius:50%;background:linear-gradient(135deg,#22c55e,#16a34a);display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 20px rgba(34,197,94,.3)}
.active-title{font-size:22px;font-weight:600;color:#22c55e}
.timer-display{font-size:40px;font-weight:300;color:#e2e8f0;margin:12px 0 8px}
.clock-in-note{font-size:13px;color:#64748b}

.history{padding:20px 16px 32px}
.history-title{margin-bottom:14px;font-size:17px;font-weight:600;color:#94a3b8}
.entry-card{background:rgba(255,255,255,.03);border-radius:14px;padding:16px;margin-bottom:10px;border:1px solid rgba(255,255,255,.05)}
.entry-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.entry-act{font-size:15px;font-weight:500}
.entry-dur{font-size:14px;font-weight:600;color:#3b82f6;background:rgba(59,130,246,.1);padding:3px 10px;border-radius:8px}
.entry-times{font-size:13px;color:#64748b;direction:ltr;text-align:right}
.del-btn{background:none;border:none;color:#475569;font-size:14px;cursor:pointer;padding:4px 6px}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:100;padding:16px}
.modal{background:#1e293b;border-radius:20px;padding:24px 20px;width:100%;max-width:380px;border:1px solid rgba(255,255,255,.08);animation:fadeIn .25s}
.modal-title{font-size:20px;font-weight:600;margin-bottom:12px}
.modal-label{font-size:14px;color:#94a3b8;font-weight:500;margin-bottom:8px;display:block}
.modal-info{padding:12px 14px;background:rgba(255,255,255,.04);border-radius:10px;font-size:14px;color:#cbd5e1;margin-bottom:16px;display:flex;justify-content:space-between}
.modal-dur{font-weight:600;color:#60a5fa}
.modal-btns{display:flex;gap:10px;margin-top:16px}
.modal-btns .btn{flex:1;font-size:15px;padding:14px}
.btn-cancel{background:transparent;border:1px solid #334155;color:#94a3b8}
.err-text{color:#ef4444;font-size:13px;margin-bottom:8px;display:none}
.err-text.show{display:block}

.act-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.act-btn{padding:14px 10px;border-radius:12px;border:1.5px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;font-family:inherit;color:#cbd5e1;transition:all .15s;font-size:13px}
.act-btn.sel{background:rgba(59,130,246,.2);border-color:#3b82f6;color:#60a5fa}
.act-icon{font-size:24px}
.note-input{margin-top:12px}

.toast{position:fixed;top:12px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:10px;color:#fff;font-size:13px;font-weight:500;z-index:200;animation:toastSlide .3s;box-shadow:0 4px 20px rgba(0,0,0,.3);white-space:nowrap}
.t-ok{background:#16a34a}.t-err{background:#dc2626}.t-wait{background:#3b82f6}

.report{padding:20px 16px 32px;animation:fadeIn .3s}
.month-nav{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:24px}
.month-arrow{width:40px;height:40px;border-radius:12px;border:1px solid #334155;background:rgba(255,255,255,.03);color:#94a3b8;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px}
.month-name{font-size:22px;font-weight:600;display:block}
.month-year{font-size:13px;color:#64748b;display:block}
.empty{text-align:center;padding:60px 20px}
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.scard{background:rgba(255,255,255,.04);border-radius:14px;padding:18px 14px;text-align:center;border:1px solid rgba(255,255,255,.05)}
.sval{font-size:26px;font-weight:600;color:#e2e8f0;margin-bottom:4px}
.slbl{font-size:13px;color:#64748b}
.brow{margin-bottom:14px}
.bhead{display:flex;justify-content:space-between;font-size:14px;margin-bottom:6px}
.bhrs{color:#64748b;font-size:13px}
.btrack{height:8px;border-radius:4px;background:rgba(255,255,255,.06);overflow:hidden}
.bfill{height:100%;border-radius:4px;background:linear-gradient(90deg,#3b82f6,#60a5fa)}
.bfill-g{height:100%;border-radius:4px;background:linear-gradient(90deg,#22c55e,#4ade80)}
.export-btn{width:100%;padding:16px;border-radius:14px;border:1px solid #334155;background:rgba(59,130,246,.08);color:#60a5fa;font-size:16px;font-weight:600;font-family:inherit;cursor:pointer;margin-top:8px}
.hidden{display:none!important}

.days-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.day-card{background:rgba(255,255,255,.03);border-radius:14px;border:1px solid rgba(255,255,255,.05);overflow:hidden}
.day-header{display:flex;justify-content:space-between;align-items:center;padding:16px;cursor:pointer;transition:background .15s}
.day-header:active{background:rgba(255,255,255,.05)}
.day-right{display:flex;align-items:center;gap:12px}
.day-arrow{font-size:14px;color:#64748b;transition:transform .2s;display:inline-block;width:16px;text-align:center}
.day-arrow.open{transform:rotate(-90deg)}
.day-info{display:flex;flex-direction:column;gap:6px}
.day-label{font-size:14px;font-weight:500;color:#e2e8f0}
.day-bar-wrap{width:100px}
.day-total{display:flex;flex-direction:column;align-items:center;background:rgba(59,130,246,.1);padding:6px 14px;border-radius:10px}
.day-hrs-val{font-size:18px;font-weight:700;color:#60a5fa}
.day-hrs-lbl{font-size:11px;color:#64748b}
.day-details{padding:0 16px 14px;border-top:1px solid rgba(255,255,255,.05)}
.detail-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.03);font-size:13px;gap:8px}
.detail-row:last-child{border-bottom:none}
.detail-act{color:#e2e8f0;flex:1;font-weight:500}
.detail-times{color:#64748b;direction:ltr;white-space:nowrap}
.detail-hrs{color:#60a5fa;font-weight:600;white-space:nowrap;min-width:55px;text-align:left}
</style>
</head>
<body>
<div class="app" id="app"></div>
<script>
// ============================================
// ×©×™× ×›××Ÿ ××ª ×›×ª×•×‘×ª ×”-Apps Script ×©×œ×š:
var SCRIPT_URL = "PASTE_YOUR_APPS_SCRIPT_URL_HERE";
// ============================================

var ACTIVITIES=[
{id:"dorms",label:"×¡×™×‘×•×‘×™ ×¤× ×™××™×”",icon:"ğŸ "},
{id:"office",label:"××©×¨×“",icon:"ğŸ’¼"},
{id:"770",label:"×‘770",icon:"ğŸ›ï¸"},
{id:"meetings",label:"××¡×™×¤×•×ª",icon:"ğŸ¤"},
{id:"fundraising",label:"×”×ª×¨××•×ª",icon:"ğŸ’°"},
{id:"cameras",label:"××¦×œ××•×ª",icon:"ğŸ“·"},
{id:"other",label:"××—×¨",icon:"ğŸ“"}
];
var MH=["×™× ×•××¨","×¤×‘×¨×•××¨","××¨×¥","××¤×¨×™×œ","×××™","×™×•× ×™","×™×•×œ×™","××•×’×•×¡×˜","×¡×¤×˜××‘×¨","××•×§×˜×•×‘×¨","× ×•×‘××‘×¨","×“×¦××‘×¨"];
var DH=["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
var SK="tt-v4";

function fm(d){return new Date(d).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})}
function fd(d){return new Date(d).toLocaleDateString("he-IL",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}
function fs(d){return new Date(d).toLocaleDateString("he-IL",{day:"numeric",month:"numeric"})}
function du(ms){var m=Math.floor(ms/60000),h=Math.floor(m/60),r=m%60;return h===0?r+" ×“×§×³":h+" ×©×¢×³"+(r>0?" "+r+" ×“×§×³":"")}
function hr(ms){return(ms/3600000).toFixed(1)}
function $(s){return document.querySelector(s)}
function $$(s){return document.querySelectorAll(s)}

var S={name:"",email:"",clockedIn:false,clockInTime:null,entries:[],view:"clock",rMonth:new Date().getMonth(),rYear:new Date().getFullYear()};

function storageKey(){return SK+"-"+S.email}
function loadS(){
  try{
    var cur=JSON.parse(localStorage.getItem(SK+"-current"));
    if(cur&&cur.email){S.name=cur.name;S.email=cur.email}
    if(S.email){
      var d=JSON.parse(localStorage.getItem(storageKey()));
      if(d){S.clockedIn=d.clockedIn||false;S.clockInTime=d.clockInTime||null;S.entries=d.entries||[];S.view=d.view||"clock";S.rMonth=d.rMonth!=null?d.rMonth:new Date().getMonth();S.rYear=d.rYear||new Date().getFullYear()}
    }
  }catch(e){}
}
function saveS(){
  try{
    if(S.email){
      localStorage.setItem(SK+"-current",JSON.stringify({name:S.name,email:S.email}));
      localStorage.setItem(storageKey(),JSON.stringify({clockedIn:S.clockedIn,clockInTime:S.clockInTime,entries:S.entries,view:S.view,rMonth:S.rMonth,rYear:S.rYear}));
    }
  }catch(e){}
}
function resetState(){
  S.name="";S.email="";S.clockedIn=false;S.clockInTime=null;S.entries=[];S.view="clock";S.rMonth=new Date().getMonth();S.rYear=new Date().getFullYear();
  localStorage.removeItem(SK+"-current");
}

function toast(msg,type,ms){
  ms=ms||3000;
  var old=$(".toast");if(old)old.remove();
  var t=document.createElement("div");t.className="toast t-"+type;t.textContent=msg;
  document.body.appendChild(t);setTimeout(function(){t.remove()},ms);
}

// ========== CROSS-ORIGIN COMMUNICATION ==========

// SENDING data: use script tag (same as JSONP - proven to work cross-origin)
function sendToSheet(entry,cb){
  var d=new Date(entry.clockIn);
  var actLabel=entry.activityId==="other"&&entry.note?"××—×¨: "+entry.note:(ACTIVITIES.filter(function(a){return a.id===entry.activityId})[0]||{}).label||"";
  var params=new URLSearchParams({
    action:"log_entry",
    employeeName:S.name,
    email:S.email,
    date:d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0"),
    day:DH[d.getDay()],
    clockIn:fm(entry.clockIn),
    clockOut:fm(entry.clockOut),
    hours:hr(entry.durationMs),
    activity:actLabel,
    note:"",
    callback:"_sendCb"+Date.now()
  });
  
  var cbName=params.get("callback");
  var done=false;
  
  window[cbName]=function(){
    if(done)return;done=true;
    try{delete window[cbName]}catch(e){}
    try{script.remove()}catch(e){}
    cb(true);
  };
  
  var script=document.createElement("script");
  script.src=SCRIPT_URL+"?"+params.toString();
  script.onerror=function(){
    if(done)return;done=true;
    try{delete window[cbName]}catch(e){}
    try{script.remove()}catch(e){}
    cb(false);
  };
  document.head.appendChild(script);
  
  setTimeout(function(){
    if(done)return;done=true;
    try{delete window[cbName]}catch(e){}
    try{script.remove()}catch(e){}
    cb(false);
  },15000);
}

// READING data: use JSONP (script tag injection)
var _jsonpCounter=0;
function jsonpFetch(url,cb){
  var cbName="_jsonp_cb_"+(++_jsonpCounter)+"_"+Date.now();
  var timeout=setTimeout(function(){
    cleanup();cb(null,"timeout");
  },15000);
  
  window[cbName]=function(data){
    cleanup();cb(data,null);
  };
  
  var script=document.createElement("script");
  script.src=url+"&callback="+cbName;
  script.onerror=function(){cleanup();cb(null,"network error")};
  document.head.appendChild(script);
  
  function cleanup(){
    clearTimeout(timeout);
    try{delete window[cbName]}catch(e){window[cbName]=undefined}
    try{script.remove()}catch(e){}
  }
}

function parseSheetRows(rows){
  var loaded=[];
  for(var i=0;i<rows.length;i++){
    try{
      var r=rows[i];
      var parts=r.date.toString().split("-");
      if(parts.length<3)continue;
      var y=parseInt(parts[0]),mo=parseInt(parts[1])-1,da=parseInt(parts[2]);
      if(isNaN(y)||isNaN(mo)||isNaN(da))continue;
      var ciParts=r.clockIn.toString().split(":");
      var coParts=r.clockOut.toString().split(":");
      if(ciParts.length<2||coParts.length<2)continue;
      var ciDate=new Date(y,mo,da,parseInt(ciParts[0]),parseInt(ciParts[1]));
      var coDate=new Date(y,mo,da,parseInt(coParts[0]),parseInt(coParts[1]));
      if(isNaN(ciDate.getTime())||isNaN(coDate.getTime()))continue;
      var ms=coDate.getTime()-ciDate.getTime();
      if(ms<0)ms+=86400000;
      var actId="other";var actNote="";
      var actLabel=r.activity.toString();
      if(actLabel.indexOf("××—×¨: ")===0){actId="other";actNote=actLabel.substring(5)}
      else{for(var j=0;j<ACTIVITIES.length;j++){if(ACTIVITIES[j].label===actLabel){actId=ACTIVITIES[j].id;break}}}
      loaded.push({id:ciDate.getTime()+i,clockIn:ciDate.getTime(),clockOut:coDate.getTime(),durationMs:ms,activityId:actId,note:actNote});
    }catch(ex){console.error("Parse error:",ex)}
  }
  return loaded;
}

function applyLoadedEntries(loaded){
  if(!loaded.length)return;
  var existingTimes={};
  for(var i=0;i<loaded.length;i++)existingTimes[loaded[i].clockIn]=true;
  for(var i=0;i<S.entries.length;i++){
    if(!existingTimes[S.entries[i].clockIn])loaded.push(S.entries[i]);
  }
  loaded.sort(function(a,b){return b.clockIn-a.clockIn});
  S.entries=loaded;
  saveS();render();
}

function syncFromSheet(showToasts){
  if(!S.email)return;
  if(showToasts)toast("â³ ×˜×•×¢×Ÿ × ×ª×•× ×™×...","wait",10000);
  var url=SCRIPT_URL+"?action=get_entries&email="+encodeURIComponent(S.email);
  jsonpFetch(url,function(rows,err){
    if(err){
      console.error("Sync error:",err);
      if(showToasts)toast("âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×”","err",4000);
      return;
    }
    if(rows&&rows.length){
      var loaded=parseSheetRows(rows);
      applyLoadedEntries(loaded);
      if(showToasts)toast("âœ… × ×˜×¢× ×• "+loaded.length+" ×¨×™×©×•××™×","ok",3000);
    }else{
      if(showToasts)toast("âœ… ××™×Ÿ ×¨×™×©×•××™× ×‘×’×™×œ×™×•×Ÿ","ok",2000);
    }
  });
}

// ========== UI ==========
function render(){
  if(!S.name||!S.email){renderLogin();return}
  var h=renderTop()+renderTabs();
  h+=S.view==="clock"?renderClock():renderReport();
  $("#app").innerHTML=h;bindAll();
}

function renderLogin(){
  $("#app").innerHTML='<div class="login"><div class="logo-area"><div class="logo-circle">â±</div><h1 class="app-title">×©×¢×•×Ÿ × ×•×›×—×•×ª</h1><p class="app-subtitle">××¢×¨×›×ª ×¨×™×©×•× ×©×¢×•×ª ×¢×‘×•×“×”</p></div><div class="login-form"><label class="field-label">×©× ××œ×</label><input type="text" id="ni" placeholder="×™×©×¨××œ ×™×©×¨××œ×™" dir="rtl"><label class="field-label" style="margin-top:8px">××™××™×™×œ</label><input type="email" id="ei" placeholder="israel@example.com" dir="ltr" style="text-align:left"><button class="btn btn-blue" id="lb" disabled>×›× ×™×¡×” ×œ××¢×¨×›×ª</button><p class="login-note">ğŸ”’ ×”××¢×¨×›×ª ×ª×–×›×•×¨ ××•×ª×š ×‘×¤×¢× ×”×‘××”</p></div></div>';
  var ni=$("#ni"),ei=$("#ei"),b=$("#lb");
  function check(){b.disabled=!(ni.value.trim()&&ei.value.trim()&&ei.value.includes("@"))}
  ni.addEventListener("input",check);
  ei.addEventListener("input",check);
  function doLogin(){
    if(ni.value.trim()&&ei.value.trim()&&ei.value.includes("@")){
      S.name=ni.value.trim();S.email=ei.value.trim().toLowerCase();
      saveS();loadS();render();
      syncFromSheet(true);
    }
  }
  ei.addEventListener("keydown",function(e){if(e.key==="Enter")doLogin()});
  ni.addEventListener("keydown",function(e){if(e.key==="Enter")ei.focus()});
  b.addEventListener("click",doLogin);
  ni.focus();
}

function renderTop(){
  return '<div class="top-bar"><div><span class="top-name">'+S.name+'</span><span class="top-badge">â— ××—×•×‘×¨</span></div><button class="small-btn" id="logoutBtn">×™×¦×™××”</button></div>';
}
function renderTabs(){
  return '<div class="tab-bar"><button class="tab '+(S.view==="clock"?"active":"")+'" data-v="clock">â± ×©×¢×•×Ÿ</button><button class="tab '+(S.view==="report"?"active":"")+'" data-v="report">ğŸ“Š ×“×•×´×— ×—×•×“×©×™</button></div>';
}

function renderClock(){
  var now=new Date(),ts=now.toDateString();
  var tms=0;
  for(var i=0;i<S.entries.length;i++){if(new Date(S.entries[i].clockIn).toDateString()===ts)tms+=S.entries[i].durationMs}
  if(S.clockedIn&&S.clockInTime)tms+=Date.now()-S.clockInTime;

  var act;
  if(!S.clockedIn){
    act='<p class="action-hint">×œ×—×¥ ×œ×”×ª×—×œ×ª ××©××¨×ª</p><button class="btn btn-green" id="ciBtn">â± ×›× ×™×¡×”</button>';
  }else{
    var el=Date.now()-S.clockInTime;
    act='<div class="active-session"><div class="pulse-box"><div class="pulse-ring"></div><div class="pulse-core">â±</div></div><h2 class="active-title">×‘××©××¨×ª</h2><div class="timer-display" id="lt">'+du(el)+'</div><p class="clock-in-note">×›× ×™×¡×”: '+fm(S.clockInTime)+'</p></div><button class="btn btn-red" id="coBtn">â± ×™×¦×™××”</button>';
  }

  var te=[];
  for(var i=0;i<S.entries.length;i++){if(new Date(S.entries[i].clockIn).toDateString()===ts)te.push(S.entries[i])}
  var hist="";
  if(te.length){
    var cards="";
    for(var i=0;i<te.length;i++){
      var e=te[i];
      var a=ACTIVITIES.filter(function(x){return x.id===e.activityId})[0];
      var l=e.activityId==="other"&&e.note?(a?a.icon:"")+" "+e.note:(a?a.icon+" "+a.label:"");
      cards+='<div class="entry-card"><div class="entry-top"><span class="entry-act">'+l+'</span><div style="display:flex;align-items:center;gap:8px"><span class="entry-dur">'+du(e.durationMs)+'</span><button class="del-btn" data-id="'+e.id+'">âœ•</button></div></div><div class="entry-times">'+fm(e.clockIn)+' â€” '+fm(e.clockOut)+'</div></div>';
    }
    hist='<div class="history"><h3 class="history-title">×”×™×•×</h3>'+cards+'</div>';
  }

  return '<div class="header"><div class="date-text">'+fd(Date.now())+'</div><div class="clock-display" id="cd">'+now.toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit",second:"2-digit"})+'</div><div class="today-summary">×¡×”×´×› ×”×™×•×: <strong id="tt">'+du(tms)+'</strong></div></div><div class="action-card">'+act+'</div>'+hist;
}

function renderReport(){
  var me=[];
  for(var i=0;i<S.entries.length;i++){var d=new Date(S.entries[i].clockIn);if(d.getMonth()===S.rMonth&&d.getFullYear()===S.rYear)me.push(S.entries[i])}
  var tot=0;for(var i=0;i<me.length;i++)tot+=me[i].durationMs;
  var dm={};
  for(var i=0;i<me.length;i++){
    var k=new Date(me[i].clockIn).toDateString();
    if(!dm[k])dm[k]={date:me[i].clockIn,ms:0,c:0,entries:[]};
    dm[k].ms+=me[i].durationMs;dm[k].c++;dm[k].entries.push(me[i]);
  }
  var days=[];for(var k in dm)days.push(dm[k]);days.sort(function(a,b){return b.date-a.date});

  var content;
  if(!me.length){
    content='<div class="empty"><div style="font-size:48px;margin-bottom:16px">ğŸ“­</div><p style="color:#64748b">××™×Ÿ × ×ª×•× ×™× ×œ×—×•×“×© ×–×”</p></div>';
  }else{
    var dayRows="";
    for(var i=0;i<days.length;i++){
      var day=days[i];
      var dd=new Date(day.date);
      var dayLabel=dd.toLocaleDateString("he-IL",{weekday:"long",day:"numeric",month:"long"});
      var pct=Math.min((day.ms/36000000)*100,100);
      var details="";
      var sorted=day.entries.slice().sort(function(a,b){return a.clockIn-b.clockIn});
      for(var j=0;j<sorted.length;j++){
        var e=sorted[j];
        var a=ACTIVITIES.filter(function(x){return x.id===e.activityId})[0];
        var l=e.activityId==="other"&&e.note?(a?a.icon:"")+" "+e.note:(a?a.icon+" "+a.label:"");
        details+='<div class="detail-row"><span class="detail-act">'+l+'</span><span class="detail-times">'+fm(e.clockIn)+' â€“ '+fm(e.clockOut)+'</span><span class="detail-hrs">'+hr(e.durationMs)+' ×©×¢×³</span></div>';
      }
      dayRows+='<div class="day-card"><div class="day-header" data-day="'+i+'"><div class="day-right"><span class="day-arrow" id="arrow-'+i+'">â—‚</span><div class="day-info"><span class="day-label">'+dayLabel+'</span><div class="day-bar-wrap"><div class="btrack" style="width:100px"><div class="bfill-g" style="width:'+pct+'%"></div></div></div></div></div><div class="day-total"><span class="day-hrs-val">'+hr(day.ms)+'</span><span class="day-hrs-lbl">×©×¢×•×ª</span></div></div><div class="day-details hidden" id="details-'+i+'">'+details+'</div></div>';
    }
    content='<div class="sgrid"><div class="scard"><div class="sval">'+hr(tot)+'</div><div class="slbl">×¡×”×´×› ×©×¢×•×ª</div></div><div class="scard"><div class="sval">'+days.length+'</div><div class="slbl">×™××™ ×¢×‘×•×“×”</div></div><div class="scard"><div class="sval">'+(days.length?hr(tot/days.length):"0")+'</div><div class="slbl">×××•×¦×¢ ×œ×™×•×</div></div><div class="scard"><div class="sval">'+me.length+'</div><div class="slbl">×¨×™×©×•××™×</div></div></div><div class="days-list">'+dayRows+'</div><button class="export-btn" id="expBtn">ğŸ“¥ ×™×™×¦×•× ×œ××§×¡×œ</button>';
  }
  return '<div class="report"><div class="month-nav"><button class="month-arrow" id="pm">â†’</button><div style="text-align:center"><span class="month-name">'+MH[S.rMonth]+'</span><span class="month-year">'+S.rYear+'</span></div><button class="month-arrow" id="nm">â†</button></div>'+content+'</div>';
}

function showOutModal(){
  var el=Date.now()-S.clockInTime;
  var ab="";
  for(var i=0;i<ACTIVITIES.length;i++){var a=ACTIVITIES[i];ab+='<button class="act-btn" data-a="'+a.id+'"><span class="act-icon">'+a.icon+'</span>'+a.label+'</button>'}
  var ov=document.createElement("div");ov.className="overlay";ov.id="outModal";
  ov.innerHTML='<div class="modal"><h3 class="modal-title">×¡×™×•× ××©××¨×ª</h3><div class="modal-info"><span>×›× ×™×¡×”: '+fm(S.clockInTime)+'</span><span class="modal-dur">'+du(el)+'</span></div><label class="modal-label">××” ×¢×©×™×ª ×‘××©××¨×ª?</label><div class="err-text" id="aerr">â¬† ×™×© ×œ×‘×—×•×¨ ×¤×¢×™×œ×•×ª</div><div class="act-grid">'+ab+'</div><div id="noteArea" class="hidden"><input type="text" class="note-input" id="noteIn" placeholder="×ª××¨ ××” ×¢×©×™×ª..." dir="rtl"></div><div id="nerr" class="err-text">×™×© ×œ×ª××¨ ××” ×¢×©×™×ª</div><div class="modal-btns"><button class="btn btn-red" id="okOut">××™×©×•×¨ ×™×¦×™××”</button><button class="btn btn-cancel" id="noOut">×‘×™×˜×•×œ</button></div></div>';
  document.body.appendChild(ov);

  var sel="";
  var btns=ov.querySelectorAll(".act-btn");
  for(var i=0;i<btns.length;i++){(function(b){
    b.addEventListener("click",function(){
      for(var j=0;j<btns.length;j++)btns[j].classList.remove("sel");
      b.classList.add("sel");sel=b.getAttribute("data-a");
      $("#aerr").classList.remove("show");$("#nerr").classList.remove("show");
      if(sel==="other"){$("#noteArea").classList.remove("hidden");var ni=$("#noteIn");if(ni)ni.focus()}
      else{$("#noteArea").classList.add("hidden")}
    });
  })(btns[i])}

  $("#noOut").addEventListener("click",function(){ov.remove()});
  ov.addEventListener("click",function(e){if(e.target===ov)ov.remove()});

  $("#okOut").addEventListener("click",function(){
    if(!sel){$("#aerr").classList.add("show");return}
    var noteEl=$("#noteIn");var note=sel==="other"?(noteEl?noteEl.value:""):"";
    if(sel==="other"&&!note.trim()){$("#nerr").classList.add("show");return}
    var n=Date.now();
    var entry={id:n,clockIn:S.clockInTime,clockOut:n,durationMs:n-S.clockInTime,activityId:sel,note:note};
    S.entries.unshift(entry);S.clockedIn=false;S.clockInTime=null;saveS();ov.remove();render();

    toast("â³ ×©×•××¨ ×‘×’×™×œ×™×•×Ÿ...","wait");
    sendToSheet(entry,function(ok){
      toast(ok?"âœ… × ×©××¨ ×‘×’×™×œ×™×•×Ÿ":"âš ï¸ ×©×’×™××” ×‘×©××™×¨×”",ok?"ok":"err",3000);
    });
  });
}

function bindAll(){
  var lo=$("#logoutBtn");if(lo)lo.addEventListener("click",function(){resetState();render()});
  var tabs=$$(".tab");for(var i=0;i<tabs.length;i++){(function(t){t.addEventListener("click",function(){S.view=t.getAttribute("data-v");render()})})(tabs[i])}
  var ci=$("#ciBtn");if(ci)ci.addEventListener("click",function(){S.clockedIn=true;S.clockInTime=Date.now();saveS();render()});
  var co=$("#coBtn");if(co)co.addEventListener("click",showOutModal);
  var dels=$$(".del-btn");for(var i=0;i<dels.length;i++){(function(b){b.addEventListener("click",function(){var id=Number(b.getAttribute("data-id"));S.entries=S.entries.filter(function(e){return e.id!==id});saveS();render()})})(dels[i])}
  var pm=$("#pm");if(pm)pm.addEventListener("click",function(){S.rMonth--;if(S.rMonth<0){S.rMonth=11;S.rYear--}render()});
  var nm=$("#nm");if(nm)nm.addEventListener("click",function(){S.rMonth++;if(S.rMonth>11){S.rMonth=0;S.rYear++}render()});
  var ex=$("#expBtn");if(ex)ex.addEventListener("click",exportCSV);
  var dh=$$(".day-header");for(var i=0;i<dh.length;i++){(function(h){h.addEventListener("click",function(){
    var idx=h.getAttribute("data-day");
    var det=document.getElementById("details-"+idx);
    var arr=document.getElementById("arrow-"+idx);
    if(det){
      if(det.classList.contains("hidden")){det.classList.remove("hidden");arr.classList.add("open")}
      else{det.classList.add("hidden");arr.classList.remove("open")}
    }
  })})(dh[i])}
}

function exportCSV(){
  var me=[];
  for(var i=0;i<S.entries.length;i++){var d=new Date(S.entries[i].clockIn);if(d.getMonth()===S.rMonth&&d.getFullYear()===S.rYear)me.push(S.entries[i])}
  if(!me.length)return;
  var tot=0;for(var i=0;i<me.length;i++)tot+=me[i].durationMs;
  var h="×©× ×¢×•×‘×“,×ª××¨×™×š,×™×•×,×›× ×™×¡×”,×™×¦×™××”,××©×š (×©×¢×•×ª),×¤×¢×™×œ×•×ª\n";
  var rev=me.slice().reverse();var rows="";
  for(var i=0;i<rev.length;i++){
    var e=rev[i];var d=new Date(e.clockIn);
    var a=ACTIVITIES.filter(function(x){return x.id===e.activityId})[0];
    var l=e.activityId==="other"&&e.note?"××—×¨: "+e.note:(a?a.label:"");
    rows+=S.name+","+d.toLocaleDateString("he-IL")+","+d.toLocaleDateString("he-IL",{weekday:"long"})+","+fm(e.clockIn)+","+fm(e.clockOut)+","+hr(e.durationMs)+","+l+"\n";
  }
  var t="×¡×”×´×›,,,,,"+hr(tot)+",\n";
  var blob=new Blob(["\uFEFF"+h+rows+t],{type:"text/csv;charset=utf-8;"});
  var url=URL.createObjectURL(blob);var a=document.createElement("a");
  a.href=url;a.download="×©×¢×•×ª_"+S.name+"_"+MH[S.rMonth]+"_"+S.rYear+".csv";a.click();URL.revokeObjectURL(url);
}

setInterval(function(){
  var c=$("#cd");if(c)c.textContent=new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  if(S.clockedIn&&S.clockInTime){
    var l=$("#lt");if(l)l.textContent=du(Date.now()-S.clockInTime);
    var t=$("#tt");if(t){
      var ts=new Date().toDateString();var ms=0;
      for(var i=0;i<S.entries.length;i++){if(new Date(S.entries[i].clockIn).toDateString()===ts)ms+=S.entries[i].durationMs}
      ms+=Date.now()-S.clockInTime;t.textContent=du(ms);
    }
  }
},1000);

loadS();render();
if(S.email){syncFromSheet(false)}
</script>
</body>
</html>
